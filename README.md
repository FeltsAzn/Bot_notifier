# Бот для отслеживания котировок на криптобиржах.

## Локальное развёртывание

Скопируйте через terminal репозиторий:
```bash
git clone https://github.com/FeltsAzn/Ctypto_info_bot
```

#### Если вы работаете через редакторы кода `vim`, `nano`, `notepad` и другие:
Установка виртуального окружения, если у вас нет его локально.
```bash
python3 -m pip install --user virtualenv
```

Создайте виртуальное окружение в скопированном репозитории:
```bash
python3 -m venv env
```

Активируйте виртуальное окружение:
```bash
source env/bin/activate
```

Установите файл с зависимостями в виртуальном окружении:
```bash
(venv):~<путь до проекта>$ pip install -r requirements.txt
```

Создайте в папке проекта файл `.env`
```bash
touch .env
```

Для корректной работы нужно в репозитории проекта создать папку **logs**:
```bash
mkdir logs
```


#### Если вы работаете через IDE:
Установите файл с зависимостями в виртуальном окружении:
```bash
(venv):~<путь до проекта>$ pip install -r requirements.txt
```

Создайте файл ***.env*** в папке проекта

Содержание файла `.env`:
```sh
BOT_TOKEN=<Токен бота от BotFather>
DATABASE_URL_ASYNC=sqlite+aiosqlite:///db/info.db # локальная база данных и драйвер для асинхронного подключения
DATABASE_URL=sqlite:///db/info.db # локальная база данных для синхронного подключения
SERVICE_URL=http://0.0.0.0:8000 
ADMIN_NAME=https://t.me/Turkey_accountt # аакаунт админа ответственного за техподдержку
SUPER_ADMIN_ID=<телеграм id админа, у которого будут супер доступ>
MULTIPROCESSORING=ON # Мультипроцессорный режим. Для отключения можно поменять "ON" на любой другой текст.
# SERVICE_URL=http://0.0.0.0:8000 for local run
# SERVICE_URL=http://fastapi:8000 for docker run
```


Для корректной работы нужно в репозитории проекта создать папку **logs**:
```bash
mkdir logs
```


!!! ВАЖНО
1. Перед запуском, нужно создать базу, для этого нужно запустить **db/**`create_database.py`.
2. Бот будет работать только вместе с его [backend](https://github.com/FeltsAzn/FastAPI-service-for-bot) частью, 
так что прежде чем запускать, скачайте 2-ю часть приложения.

Запуск из терминала -> `python3 app.py`


#### Docker контейнер

Вы можете развернуть приложение на сервере или локально в контейнере используя ***dockerfile***:
```bash
docker build . -t <название образа>
```

И запустить собранный образ в контейнере:
```bash
docker run -d <название образа>
```


Есть возможность поднять кластер для бота и его [backend](https://github.com/FeltsAzn/FastAPI-service-for-bot) части в docker-compose:
```bash
"Изменяем путь до API для бота"

services:
  fastapi:
    image: fastapi
    container_name: fastapi_app
    ports:
    - "8000:8000"
    build:
      context: <асболютный путь в системе до dockerfile для fastapi сервиса>
      dockerfile: dockerfile
.....
```

Прописываем в терминале IDE или терминале операционной системы:
```bash
docker compose -f docker-compose.dev.yaml up -d --build
``` 


_____________________________________________________________

Приложение написано на библиотеке `aiogramm`. Имеется два типа работы: однопоточный режим и мультипроцессорный.



Запуск из терминала -> `python3 app.py`

Приложение написано на библиотеке `aiogramm`. Имеется два типа работы: однопоточный режим и мультипроцессорный.
Изменение режима работы бота возможна через файл "*.env*".

Для запуска мультипроцессорного режима `MULTIPROCESSORING=ON`
Для запуска однопоточного режима `MULTIPROCESSORING={Любые символы}`

Бот состоит из 3-х частей:

- Реализация уведомлений пользователей находится в папке *alerts_worker*.

- База данных пользователей бота и методы CRUD лежат в папке *db*.

- Обработчики клавиатуры бота лежат в папке *handlers*


### Администратор
Административный интерфейс состоит списка пользователей и настроек администратора(пока в работе)

#### Список пользователей:
Просмотр списка пользователей через inline-keyboard.
Доступная информация:
- Telegram id
- Имя пользователя
- Активность уведомлений

Есть возможность удаление пользователя по желанию администратора
(отключена возможность удаления самого себя через административную панель).

### Пользователь
Пользовательский интерфейс состоит из списка отслеживаемых бирж и настроек

#### Настройки
- Отключение/включение уведомлений от бота.
- Удаление аккаунта из базы бота, для прекращения получения сообщений
(бот записывает пользователя в базу и будет присылать уведомления,
даже после удаления диалога с ботом)

**Пользователь бота получает уведомления о котировках валют только доступных для продажи/покупки.**


Бот настроен на постоянную работу на сервере, поэтому только в случае критической ошибки
произойдёт выход из приложения (отключение сервера, ручная остановка, ошибка телеграмма).

Запросы к биржам осуществляется через внутренний сервис написанный на `FastAPI`.

Фильтрование информации по валютам осуществляется через `config.py` файл в папке *alerts_worker*.
Где выставлены константы:
- Высокий процент (выделяется в уведомлениях)
- Стартовый процент, при котором начинаются отправляться уведомления пользователям
- Минимальный шаг вверх, при повышении разрыва котировок
- Минимальный шаг вниз при повышении разрыва котировок

Время прохода цикла обработки информации с бирж ~3 секунды.

